#!/usr/bin/env python3
import RPi.GPIO as GPIO
import time
from RPLCD.i2c import CharLCD

# --- PIN BCM ---
ROW_PINS = [5, 6, 13, 19]    # R1, R2, R3, R4
COL_PINS = [12, 16, 20, 21]  # C1, C2, C3, C4

# --- LED ---
LED_MERAH = 17
LED_KUNING = 27
LED_HIJAU = 22

# --- Keymap 4x4 ---
KEYMAP = [
    ['1','2','3','A'],
    ['4','5','6','B'],
    ['7','8','9','C'],
    ['*','0','#','D']
]

# --- Password ---
PASSWORD = "1234"

# --- LCD I2C ---
lcd = CharLCD('PCF8574', 0x27)

def setup():
    GPIO.setmode(GPIO.BCM)
    for r in ROW_PINS:
        GPIO.setup(r, GPIO.OUT)
        GPIO.output(r, GPIO.LOW)
    for c in COL_PINS:
        GPIO.setup(c, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)

    GPIO.setup(LED_MERAH, GPIO.OUT)
    GPIO.setup(LED_KUNING, GPIO.OUT)
    GPIO.setup(LED_HIJAU, GPIO.OUT)
    GPIO.output(LED_MERAH, GPIO.LOW)
    GPIO.output(LED_KUNING, GPIO.HIGH)   # standby awal
    GPIO.output(LED_HIJAU, GPIO.LOW)

def cleanup():
    GPIO.cleanup()
    lcd.clear()

def get_key():
    while True:
        for i, r in enumerate(ROW_PINS):
            GPIO.output(r, GPIO.HIGH)
            time.sleep(0.001)
            for j, c in enumerate(COL_PINS):
                if GPIO.input(c) == GPIO.HIGH:
                    key = KEYMAP[i][j]
                    while GPIO.input(c) == GPIO.HIGH:
                        time.sleep(0.01)
                    time.sleep(0.1)
                    GPIO.output(r, GPIO.LOW)
                    return key
            GPIO.output(r, GPIO.LOW)
        time.sleep(0.01)

def show_message(line1="", line2=""):
    lcd.clear()
    lcd.cursor_pos = (0, 0)  # baris pertama
    lcd.write_string(line1[:16])  # max 16 karakter
    lcd.cursor_pos = (1, 0)  # baris kedua
    lcd.write_string(line2[:16])

def main():
    try:
        setup()
        show_message("Masukkan", "Password:")

        input_pw = ""
        while True:
            k = get_key()
            if k == "#":
                if input_pw == PASSWORD:
                    show_message("Password Benar", "Akses Diterima")
                    GPIO.output(LED_KUNING, GPIO.LOW)
                    GPIO.output(LED_HIJAU, GPIO.HIGH)
                    time.sleep(2)
                    GPIO.output(LED_HIJAU, GPIO.LOW)
                    GPIO.output(LED_KUNING, GPIO.HIGH)
                    show_message("Masukkan", "Password:")
                    input_pw = ""
                else:
                    show_message("Password Salah", "Coba Lagi")
                    GPIO.output(LED_KUNING, GPIO.LOW)
                    GPIO.output(LED_MERAH, GPIO.HIGH)
                    time.sleep(2)
                    GPIO.output(LED_MERAH, GPIO.LOW)
                    GPIO.output(LED_KUNING, GPIO.HIGH)
                    show_message("Masukkan", "Password:")
                    input_pw = ""
            elif k == "*":
                input_pw = ""
                show_message("Masukkan", "Password:")
            else:
                input_pw += k
                show_message("Masukkan:", "*" * len(input_pw))

    except KeyboardInterrupt:
        print("\nProgram dihentikan.")
    finally:
        cleanup()

if __name__ == "__main__":
    main()
